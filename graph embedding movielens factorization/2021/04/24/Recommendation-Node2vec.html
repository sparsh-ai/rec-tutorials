<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Recommender System with Node2vec Graph Embeddings | rec-tutorials</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Recommender System with Node2vec Graph Embeddings" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A tutorial on building a movie recommender system that will learn user-item representation using graph embedding and comparing performance with other methods like matrix factorization" />
<meta property="og:description" content="A tutorial on building a movie recommender system that will learn user-item representation using graph embedding and comparing performance with other methods like matrix factorization" />
<link rel="canonical" href="https://sparsh-ai.github.io/rec-tutorials/graph%20embedding%20movielens%20factorization/2021/04/24/Recommendation-Node2vec.html" />
<meta property="og:url" content="https://sparsh-ai.github.io/rec-tutorials/graph%20embedding%20movielens%20factorization/2021/04/24/Recommendation-Node2vec.html" />
<meta property="og:site_name" content="rec-tutorials" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-24T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://sparsh-ai.github.io/rec-tutorials/graph%20embedding%20movielens%20factorization/2021/04/24/Recommendation-Node2vec.html","@type":"BlogPosting","headline":"Recommender System with Node2vec Graph Embeddings","dateModified":"2021-04-24T00:00:00-05:00","datePublished":"2021-04-24T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://sparsh-ai.github.io/rec-tutorials/graph%20embedding%20movielens%20factorization/2021/04/24/Recommendation-Node2vec.html"},"description":"A tutorial on building a movie recommender system that will learn user-item representation using graph embedding and comparing performance with other methods like matrix factorization","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/rec-tutorials/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://sparsh-ai.github.io/rec-tutorials/feed.xml" title="rec-tutorials" /><link rel="shortcut icon" type="image/x-icon" href="/rec-tutorials/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/rec-tutorials/">rec-tutorials</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/rec-tutorials/about/">About Me</a><a class="page-link" href="/rec-tutorials/search/">Search</a><a class="page-link" href="/rec-tutorials/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Recommender System with Node2vec Graph Embeddings</h1><p class="page-description">A tutorial on building a movie recommender system that will learn user-item representation using graph embedding and comparing performance with other methods like matrix factorization</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-04-24T00:00:00-05:00" itemprop="datePublished">
        Apr 24, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      16 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/rec-tutorials/categories/#graph embedding movielens factorization">graph embedding movielens factorization</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/sparsh-ai/rec-tutorials/tree/master/_notebooks/2021-04-24-Recommendation-Node2vec.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/rec-tutorials/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/sparsh-ai/rec-tutorials/master?filepath=_notebooks%2F2021-04-24-Recommendation-Node2vec.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/rec-tutorials/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/sparsh-ai/rec-tutorials/blob/master/_notebooks/2021-04-24-Recommendation-Node2vec.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/rec-tutorials/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Data-gathering-and-exploration">Data gathering and exploration </a></li>
<li class="toc-entry toc-h2"><a href="#Neighborhood-method">Neighborhood method </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Jaccard-Similarity">Jaccard Similarity </a></li>
<li class="toc-entry toc-h3"><a href="#Cosine-similarity">Cosine similarity </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Factorization-method">Factorization method </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Singular-Value-Decomposition">Singular Value Decomposition </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Graph-Embedding-method">Graph Embedding method </a>
<ul>
<li class="toc-entry toc-h3"><a href="#DeepWalk">DeepWalk </a></li>
<li class="toc-entry toc-h3"><a href="#Evaluation">Evaluation </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Enriched-network-with-additional-information-:-Genres">Enriched network with additional information : Genres </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-04-24-Recommendation-Node2vec.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-gathering-and-exploration">
<a class="anchor" href="#Data-gathering-and-exploration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data gathering and exploration<a class="anchor-link" href="#Data-gathering-and-exploration"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">rating_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'ml100k_ratings.csv'</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">','</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rating_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>4.0</td>
      <td>964982703</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>4.0</td>
      <td>964981247</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>6</td>
      <td>4.0</td>
      <td>964982224</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>47</td>
      <td>5.0</td>
      <td>964983815</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>50</td>
      <td>5.0</td>
      <td>964982931</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movie_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'ml100k_movies.csv'</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">','</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">movie_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Toy Story (1995)</td>
      <td>Adventure|Animation|Children|Comedy|Fantasy</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Jumanji (1995)</td>
      <td>Adventure|Children|Fantasy</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Grumpier Old Men (1995)</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Waiting to Exhale (1995)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Father of the Bride Part II (1995)</td>
      <td>Comedy</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Neighborhood-method">
<a class="anchor" href="#Neighborhood-method" aria-hidden="true"><span class="octicon octicon-link"></span></a>Neighborhood method<a class="anchor-link" href="#Neighborhood-method"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Jaccard-Similarity">
<a class="anchor" href="#Jaccard-Similarity" aria-hidden="true"><span class="octicon octicon-link"></span></a>Jaccard Similarity<a class="anchor-link" href="#Jaccard-Similarity"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If we ignore the ratings that the users have given to the movies, and consider the movies that the users have watched, we get a set of movies/users for every user/movie. Think of this formulation as a bipartite graph of users and movies where there is an edge between a user and a movie if a user has watched the movie, the edges have all same weights.</p>
<p>Create a dictionary of movies as keys and values as users that have rated them</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since we have a set of users to characterize each movie, to compute the similarity of two movies, we use Jaccard Index which, for two sets, is the ratio of number of elements in the intersection and number of elements in the union.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">jaccard</span><span class="p">(</span><span class="n">movie1</span><span class="p">,</span> <span class="n">movie2</span><span class="p">,</span> <span class="n">movie_sets</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">movie_sets</span><span class="p">[</span><span class="n">movie1</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">movie_sets</span><span class="p">[</span><span class="n">movie2</span><span class="p">]</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">intersection</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">intersection</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's explore similarity between some movies, qualitatively. We use the movies dataframe to get the names of the movies via their Ids.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="mi">260</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'Star Wars: Episode IV - A New Hope (1977)'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Jaccard distance between 'StarWars:EpisodeIV-ANewHope(1977)' and 'StarWars:EpisodeV-TheEmpireStrikesBack(1980)' is 0.70
Jaccard distance between 'StarWars:EpisodeIV-ANewHope(1977)' and 'StarWars:EpisodeVI-ReturnoftheJedi(1983)' is 0.64
Jaccard distance between 'StarWars:EpisodeIV-ANewHope(1977)' and 'ToyStory(1995)' is 0.40
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The movie Star Wars IV has higher similarity score with other Star Wars as compared to Toy Story.</p>
<p>Using the Jaccard Index, we can retrieve top-k similar movies to a given movie. This provides a way to recommend movies of a user which are similar to the movies that the user has watched.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">get_similar_movies_jaccard</span><span class="p">(</span><span class="mi">260</span><span class="p">,</span> <span class="n">movie_sets</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'movie': 'Star Wars: Episode IV - A New Hope (1977)',
 'sim_movies': ['Star Wars: Episode IV - A New Hope (1977)',
  'Star Wars: Episode V - The Empire Strikes Back (1980)',
  'Star Wars: Episode VI - Return of the Jedi (1983)',
  'Raiders of the Lost Ark (Indiana Jones and the Raiders of the Lost Ark) (1981)',
  'Matrix, The (1999)']}</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">get_similar_movies_jaccard</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">movie_sets</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'movie': 'Toy Story (1995)',
 'sim_movies': ['Toy Story (1995)',
  'Independence Day (a.k.a. ID4) (1996)',
  'Jurassic Park (1993)',
  'Star Wars: Episode IV - A New Hope (1977)',
  'Forrest Gump (1994)']}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Cosine-similarity">
<a class="anchor" href="#Cosine-similarity" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cosine similarity<a class="anchor-link" href="#Cosine-similarity"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Rather than the set based similarity like Jaccard, we can define every movie as a sparse vector of dimension equal to the number of users and the vector entry corresponding to each user is given by the rating that the user has for the movie or zero if no rating exists (i.e. the user hasn't seen/rated the movie).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cosine</span><span class="p">(</span><span class="n">movie_sparse_vecs</span><span class="p">[</span><span class="mi">224</span><span class="p">],</span> <span class="n">movie_sparse_vecs</span><span class="p">[</span><span class="mi">897</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0.8324073552233735
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">get_similar_movies_nbd_cosine</span><span class="p">(</span><span class="n">movieid</span><span class="p">,</span> <span class="n">movie_vecs</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="n">movieid</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">movie_idx</span> <span class="o">=</span> <span class="n">movie2id</span><span class="p">[</span><span class="n">movieid</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">movie_vecs</span><span class="p">[</span><span class="n">movie_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ranking</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">movie_vecs</span><span class="p">,</span><span class="n">query</span><span class="p">)</span>
    <span class="n">top_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ranking</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">top_ids</span> <span class="o">=</span> <span class="n">top_ids</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">top_n</span><span class="p">]</span>
    <span class="n">top_movie_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">movies</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">top_ids</span><span class="p">]</span>
    <span class="n">sim_movies</span> <span class="o">=</span> <span class="p">[</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">top_movie_ids</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">'movie'</span><span class="p">:</span> <span class="n">movie</span><span class="p">,</span> <span class="s1">'sim_movies'</span><span class="p">:</span> <span class="n">sim_movies</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movieid</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">movie_data</span> <span class="o">=</span> <span class="n">movie_sparse_vecs</span>
<span class="n">get_similar_movies_nbd_cosine</span><span class="p">(</span><span class="n">movieid</span><span class="p">,</span> <span class="n">movie_data</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'movie': 'Toy Story (1995)',
 'sim_movies': ['Toy Story (1995)',
  'Toy Story 2 (1999)',
  'Jurassic Park (1993)',
  'Independence Day (a.k.a. ID4) (1996)',
  'Star Wars: Episode IV - A New Hope (1977)']}</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movieid</span> <span class="o">=</span> <span class="mi">260</span>
<span class="n">movie_data</span> <span class="o">=</span> <span class="n">movie_sparse_vecs</span>
<span class="n">get_similar_movies_nbd_cosine</span><span class="p">(</span><span class="n">movieid</span><span class="p">,</span> <span class="n">movie_data</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'movie': 'Star Wars: Episode IV - A New Hope (1977)',
 'sim_movies': ['Star Wars: Episode IV - A New Hope (1977)',
  'Star Wars: Episode V - The Empire Strikes Back (1980)',
  'Star Wars: Episode VI - Return of the Jedi (1983)',
  'Raiders of the Lost Ark (Indiana Jones and the Raiders of the Lost Ark) (1981)',
  'Matrix, The (1999)']}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Factorization-method">
<a class="anchor" href="#Factorization-method" aria-hidden="true"><span class="octicon octicon-link"></span></a>Factorization method<a class="anchor-link" href="#Factorization-method"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Singular-Value-Decomposition">
<a class="anchor" href="#Singular-Value-Decomposition" aria-hidden="true"><span class="octicon octicon-link"></span></a>Singular Value Decomposition<a class="anchor-link" href="#Singular-Value-Decomposition"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A very popular technique for recommendation systems is via matrix factorization. The idea is to reduce the dimensionality of the data before calculating similar movies/users. We factorize the user-item matrix to obtain the user factors and item factors which are the low-dimensional embeddings such that 'similar' user/items are mapped to 'nearby' points.</p>
<p>This kind of analysis can generate matches that are impossible to find with the techniques discussed above as the latent factors can capture attributes which are hard for raw data to deciper e.g. a latent factor can correspond to the degree to which a movie is female oriented or degree to which there is a slow development of the charcters.</p>
<p>Moreover, the user and the movies are embedded to the same space, which provides a direct way to compute user-movie similarity.</p>
<p>We will use Singular Value Decomposition (SVD) for factorizing the matrix.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Normalize the rating matrix</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">normalised_mat</span> <span class="o">=</span> <span class="n">ratings_mat</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ratings_mat</span><span class="p">,</span> <span class="mi">1</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The number of the latent-factors is chosen to be 50 i.e. top-50 singular values of the SVD are considered. The choice of the number of latent factors is a hyperparameter of the model, and requires a more sophisticated analysis to tune. We provide no reason for the choice of 50.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">n_factors</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">normalised_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratings_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">svds</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">n_factors</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(610, 50) (50, 9724)
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movie_factors</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">T</span>
<span class="n">user_factors</span> <span class="o">=</span> <span class="n">U</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Instead of representing each movie as a sparse vector of the ratings of all 360,000 possible users for it, after factorizing the matrix each movie will be represented by a 50 dimensional dense vector.</p>
<p>Define a routine to get top-n movies similar to a given movie.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">get_similar_movies_matrix_factorization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">movieid</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">movieid</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># Movie id starts from 1</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="n">movieid</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">movie_row</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">movie_row</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">sort_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">similarity</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">'movie'</span><span class="p">:</span> <span class="n">movie</span><span class="p">,</span> <span class="s1">'sim_movies'</span><span class="p">:</span> <span class="p">[</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">sort_indexes</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]}</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movie_id</span> <span class="o">=</span> <span class="mi">260</span>
<span class="n">get_similar_movies_matrix_factorization</span><span class="p">(</span><span class="n">movie_factors</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'movie': 'Priest (1994)',
 'sim_movies': ['Priest (1994)',
  'Heidi Fleiss: Hollywood Madam (1995)',
  'Reds (1981)',
  'I Went Down (1997)',
  'Metroland (1997)',
  'Love Serenade (1996)',
  'Cold Fever (Á köldum klaka) (1995)',
  'Suture (1993)',
  'Whole Wide World, The (1996)',
  'Walking and Talking (1996)']}</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movie_id</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">get_similar_movies_matrix_factorization</span><span class="p">(</span><span class="n">movie_factors</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'movie': 'Toy Story (1995)',
 'sim_movies': ['Toy Story (1995)',
  'Back to the Future (1985)',
  "Bug's Life, A (1998)",
  'Babe (1995)',
  'Star Wars: Episode IV - A New Hope (1977)',
  'Who Framed Roger Rabbit? (1988)',
  'Mrs. Doubtfire (1993)',
  'When Harry Met Sally... (1989)',
  '101 Dalmatians (One Hundred and One Dalmatians) (1961)',
  'Home Alone (1990)']}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since the user and movies are in the same space, we can also compute movies similar to a user. A recommendation model can be defined as showing movies similar to the given user.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">get_recommendations_matrix_factorization</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">user_factors</span><span class="p">,</span> <span class="n">movie_factors</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">user_vec</span> <span class="o">=</span> <span class="n">user_factors</span><span class="p">[</span><span class="n">userid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">user_vec</span><span class="p">,</span> <span class="n">movie_factors</span><span class="p">)</span>
    <span class="n">sort_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">similarity</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">sort_indexes</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">top_recos</span> <span class="o">=</span> <span class="n">get_recommendations_matrix_factorization</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_factors</span><span class="p">,</span> <span class="n">movie_factors</span><span class="p">)</span>
<span class="n">top_recos</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['Jungle2Jungle (a.k.a. Jungle 2 Jungle) (1997)',
 "Pete's Dragon (2016)",
 'Cellular (2004)',
 'Replacement Killers, The (1998)',
 'Rough Night (2017)',
 'Star Wars: Episode III - Revenge of the Sith (2005)',
 'Gentlemen Prefer Blondes (1953)',
 'Spanglish (2004)',
 'Sorry to Bother You (2018)',
 'Planet of the Apes (2001)']</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Graph-Embedding-method">
<a class="anchor" href="#Graph-Embedding-method" aria-hidden="true"><span class="octicon octicon-link"></span></a>Graph Embedding method<a class="anchor-link" href="#Graph-Embedding-method"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create a user-movie graph with edge weights as the ratings. We will use DeepWalk to embed every node of the graph to a low-dimensional space.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">user_item_edgelist</span> <span class="o">=</span> <span class="n">rating_df</span><span class="p">[[</span><span class="s1">'userId'</span><span class="p">,</span> <span class="s1">'movieId'</span><span class="p">,</span> <span class="s1">'rating'</span><span class="p">]]</span>
<span class="n">user_item_edgelist</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>6</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>44</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>47</td>
      <td>5.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create a user-movie weighted graph using python library networkx.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">user_movie_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">user_item_edgelist</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="n">usr</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'user'</span><span class="p">)</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'movie'</span><span class="p">)</span>
    <span class="n">user_movie_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">user2dict</span><span class="p">[</span><span class="n">usr</span><span class="p">])</span>
    <span class="n">user_movie_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">movie2dict</span><span class="p">[</span><span class="n">movie</span><span class="p">])</span>
    <span class="n">user_movie_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">user2dict</span><span class="p">[</span><span class="n">usr</span><span class="p">],</span> <span class="n">movie2dict</span><span class="p">[</span><span class="n">movie</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">user_movie_graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>100836</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">user_movie_graph</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>10334</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="DeepWalk">
<a class="anchor" href="#DeepWalk" aria-hidden="true"><span class="octicon octicon-link"></span></a>DeepWalk<a class="anchor-link" href="#DeepWalk"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We will use the implementation of DeepWalk provided in node2vec which is a bit different from original DeepWalk e.g. it uses negative sampling whereas the original DeepWalk paper used hierarchical sampling for the skip-gram model.</p>
<p>To create embeddings from the context and non-context pairs, we are using Gensim python library. One can easily use Google word2vec or Facebook fasttext for this task.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">random</span>


<span class="k">class</span> <span class="nc">Graph</span><span class="p">():</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx_G</span><span class="p">,</span> <span class="n">is_directed</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">nx_G</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">is_directed</span> <span class="o">=</span> <span class="n">is_directed</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>

	<span class="k">def</span> <span class="nf">node2vec_walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">walk_length</span><span class="p">,</span> <span class="n">start_node</span><span class="p">):</span>
		<span class="sd">'''</span>
<span class="sd">		Simulate a random walk starting from start node.</span>
<span class="sd">		'''</span>
		<span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
		<span class="n">alias_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_nodes</span>
		<span class="n">alias_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_edges</span>

		<span class="n">walk</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_node</span><span class="p">]</span>

		<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">walk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">walk_length</span><span class="p">:</span>
			<span class="n">cur</span> <span class="o">=</span> <span class="n">walk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">cur_nbrs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">cur</span><span class="p">))</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_nbrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">walk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">walk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_nbrs</span><span class="p">[</span><span class="n">alias_draw</span><span class="p">(</span><span class="n">alias_nodes</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">alias_nodes</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">prev</span> <span class="o">=</span> <span class="n">walk</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
					<span class="nb">next</span> <span class="o">=</span> <span class="n">cur_nbrs</span><span class="p">[</span><span class="n">alias_draw</span><span class="p">(</span><span class="n">alias_edges</span><span class="p">[(</span><span class="n">prev</span><span class="p">,</span> <span class="n">cur</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span> 
						<span class="n">alias_edges</span><span class="p">[(</span><span class="n">prev</span><span class="p">,</span> <span class="n">cur</span><span class="p">)][</span><span class="mi">1</span><span class="p">])]</span>
					<span class="n">walk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">break</span>

		<span class="k">return</span> <span class="n">walk</span>

	<span class="k">def</span> <span class="nf">simulate_walks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_walks</span><span class="p">,</span> <span class="n">walk_length</span><span class="p">):</span>
		<span class="sd">'''</span>
<span class="sd">		Repeatedly simulate random walks from each node.</span>
<span class="sd">		'''</span>
		<span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
		<span class="n">walks</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">'Walk iteration:'</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">walk_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_walks</span><span class="p">):</span>
			<span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">walk_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">'/'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_walks</span><span class="p">))</span>
			<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
				<span class="n">walks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node2vec_walk</span><span class="p">(</span><span class="n">walk_length</span><span class="o">=</span><span class="n">walk_length</span><span class="p">,</span> <span class="n">start_node</span><span class="o">=</span><span class="n">node</span><span class="p">))</span>

		<span class="k">return</span> <span class="n">walks</span>

	<span class="k">def</span> <span class="nf">get_alias_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
		<span class="sd">'''</span>
<span class="sd">		Get the alias edge setup lists for a given edge.</span>
<span class="sd">		'''</span>
		<span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
		<span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
		<span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span>

		<span class="n">unnormalized_probs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">dst_nbr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">dst</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">dst_nbr</span> <span class="o">==</span> <span class="n">src</span><span class="p">:</span>
				<span class="n">unnormalized_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">dst</span><span class="p">][</span><span class="n">dst_nbr</span><span class="p">][</span><span class="s1">'weight'</span><span class="p">]</span><span class="o">/</span><span class="n">p</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">G</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">dst_nbr</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
				<span class="n">unnormalized_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">dst</span><span class="p">][</span><span class="n">dst_nbr</span><span class="p">][</span><span class="s1">'weight'</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">unnormalized_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">dst</span><span class="p">][</span><span class="n">dst_nbr</span><span class="p">][</span><span class="s1">'weight'</span><span class="p">]</span><span class="o">/</span><span class="n">q</span><span class="p">)</span>
		<span class="n">norm_const</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">unnormalized_probs</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">normalized_probs</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">u_prob</span><span class="p">)</span><span class="o">/</span><span class="n">norm_const</span> <span class="k">for</span> <span class="n">u_prob</span> <span class="ow">in</span> <span class="n">unnormalized_probs</span><span class="p">]</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="n">normalized_probs</span> <span class="o">=</span>  <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">u_prob</span> <span class="ow">in</span> <span class="n">unnormalized_probs</span><span class="p">]</span>

		<span class="k">return</span> <span class="n">alias_setup</span><span class="p">(</span><span class="n">normalized_probs</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">preprocess_transition_probs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">'''</span>
<span class="sd">		Preprocessing of transition probabilities for guiding the random walks.</span>
<span class="sd">		'''</span>
		<span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
		<span class="n">is_directed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_directed</span>

		<span class="n">alias_nodes</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
			<span class="n">unnormalized_probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">nbr</span><span class="p">][</span><span class="s1">'weight'</span><span class="p">]</span> <span class="k">for</span> <span class="n">nbr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">))]</span>
			<span class="n">norm_const</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">unnormalized_probs</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">normalized_probs</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">u_prob</span><span class="p">)</span><span class="o">/</span><span class="n">norm_const</span> <span class="k">for</span> <span class="n">u_prob</span> <span class="ow">in</span> <span class="n">unnormalized_probs</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
				<span class="n">normalized_probs</span> <span class="o">=</span>  <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">u_prob</span> <span class="ow">in</span> <span class="n">unnormalized_probs</span><span class="p">]</span>
			<span class="n">alias_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias_setup</span><span class="p">(</span><span class="n">normalized_probs</span><span class="p">)</span>

		<span class="n">alias_edges</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">triads</span> <span class="o">=</span> <span class="p">{}</span>

		<span class="k">if</span> <span class="n">is_directed</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
				<span class="n">alias_edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alias_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
				<span class="n">alias_edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alias_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">alias_edges</span><span class="p">[(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alias_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">alias_nodes</span> <span class="o">=</span> <span class="n">alias_nodes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">alias_edges</span> <span class="o">=</span> <span class="n">alias_edges</span>

		<span class="k">return</span>


<span class="k">def</span> <span class="nf">alias_setup</span><span class="p">(</span><span class="n">probs</span><span class="p">):</span>
	<span class="sd">'''</span>
<span class="sd">	Compute utility lists for non-uniform sampling from discrete distributions.</span>
<span class="sd">	Refer to https://hips.seas.harvard.edu/blog/2013/03/03/the-alias-method-efficient-sampling-with-many-discrete-outcomes/</span>
<span class="sd">	for details</span>
<span class="sd">	'''</span>
	<span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
	<span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

	<span class="n">smaller</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">larger</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">probs</span><span class="p">):</span>
	    <span class="n">q</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="o">*</span><span class="n">prob</span>
	    <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
	        <span class="n">smaller</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
	    <span class="k">else</span><span class="p">:</span>
	        <span class="n">larger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>

	<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">smaller</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">larger</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
	    <span class="n">small</span> <span class="o">=</span> <span class="n">smaller</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
	    <span class="n">large</span> <span class="o">=</span> <span class="n">larger</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

	    <span class="n">J</span><span class="p">[</span><span class="n">small</span><span class="p">]</span> <span class="o">=</span> <span class="n">large</span>
	    <span class="n">q</span><span class="p">[</span><span class="n">large</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">large</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="n">small</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span>
	    <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="n">large</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
	        <span class="n">smaller</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">large</span><span class="p">)</span>
	    <span class="k">else</span><span class="p">:</span>
	        <span class="n">larger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">large</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">J</span><span class="p">,</span> <span class="n">q</span>

<span class="k">def</span> <span class="nf">alias_draw</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
	<span class="sd">'''</span>
<span class="sd">	Draw sample from a non-uniform discrete distribution using alias sampling.</span>
<span class="sd">	'''</span>
	<span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>

	<span class="n">kk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">*</span><span class="n">K</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">[</span><span class="n">kk</span><span class="p">]:</span>
	    <span class="k">return</span> <span class="n">kk</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">J</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">G</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">user_movie_graph</span><span class="p">,</span> <span class="n">is_directed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>p,q = 1 for DeeWalk as the random walks are completely unbiased.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">G</span><span class="o">.</span><span class="n">preprocess_transition_probs</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Compute the random walks.</p>
<ul>
<li>10 walks for every node.</li>
<li>Each walk of length 80.</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">walks</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">simulate_walks</span><span class="p">(</span><span class="n">num_walks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">walk_length</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Walk iteration:
1 / 10
2 / 10
3 / 10
4 / 10
5 / 10
6 / 10
7 / 10
8 / 10
9 / 10
10 / 10
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">walks</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>103340</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Learn Embeddings via Gensim, which creates context/non-context pairs and then Skip-gram.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">learn_embeddings</span><span class="p">(</span><span class="n">walks</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Learn embeddings by optimizing the Skipgram objective using SGD.</span>
<span class="sd">    Uses Gensim Word2Vec.</span>
<span class="sd">    '''</span>
    <span class="n">walks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">walk</span><span class="p">))</span> <span class="k">for</span> <span class="n">walk</span> <span class="ow">in</span> <span class="n">walks</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Word2Vec</span><span class="p">(</span><span class="n">walks</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">wv</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">node_embeddings</span> <span class="o">=</span> <span class="n">learn_embeddings</span><span class="p">(</span><span class="n">walks</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The output of gensim is a specific type of key-value pair with keys as the string-ed node ids and the values are numpy array of embeddings, each of shape (50,)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">node_embeddings</span><span class="p">[</span><span class="s1">'0'</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([-2.1159494e-02, -4.3432057e-01,  6.9623584e-01,  4.8146245e-01,
        9.6677847e-02, -3.1050149e-02,  1.9733864e-01,  7.9867625e-01,
       -6.6979128e-01,  6.5312237e-01,  3.1304079e-01, -1.3411559e-01,
       -1.5454048e-01, -2.7333325e-01,  1.4711864e-01,  2.2469629e-01,
       -4.3890166e-01,  2.9871342e-01, -6.9798152e-03, -1.7996507e-02,
       -6.7855030e-02, -4.3489739e-01,  1.5584855e-01,  7.7486165e-02,
        3.7617716e-01,  2.8012756e-01, -8.3905622e-02, -3.5362533e-01,
        2.2293477e-01, -1.4108117e-01,  1.6970167e-01, -6.3179672e-01,
        1.5170584e-02,  6.1733756e-02, -1.2013953e-01, -2.3064958e-01,
        2.4610328e-02,  5.0556450e-04,  2.1398006e-01, -1.0361964e-01,
        4.8838145e-01, -3.6318046e-01, -3.1330651e-01,  8.6576389e-03,
        1.9654050e-02, -4.6078888e-01,  2.7895319e-01, -1.7853497e-04,
       -1.7593203e-01,  2.8144377e-01], dtype=float32)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movie1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">movie2dict</span><span class="p">[(</span><span class="mi">260</span><span class="p">,</span> <span class="s1">'movie'</span><span class="p">)])</span>
<span class="n">movie2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">movie2dict</span><span class="p">[(</span><span class="mi">1196</span><span class="p">,</span> <span class="s1">'movie'</span><span class="p">)])</span>
<span class="mf">1.0</span> <span class="o">-</span> <span class="n">cosine</span><span class="p">(</span><span class="n">node_embeddings</span><span class="p">[</span><span class="n">movie1</span><span class="p">],</span> <span class="n">node_embeddings</span><span class="p">[</span><span class="n">movie2</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.42126354575157166</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movie3</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">movie2dict</span><span class="p">[(</span><span class="mi">1210</span><span class="p">,</span> <span class="s1">'movie'</span><span class="p">)])</span>
<span class="mf">1.0</span> <span class="o">-</span> <span class="n">cosine</span><span class="p">(</span><span class="n">node_embeddings</span><span class="p">[</span><span class="n">movie1</span><span class="p">],</span> <span class="n">node_embeddings</span><span class="p">[</span><span class="n">movie3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.29301050305366516</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movie4</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">movie2dict</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'movie'</span><span class="p">)])</span>
<span class="mf">1.0</span> <span class="o">-</span> <span class="n">cosine</span><span class="p">(</span><span class="n">node_embeddings</span><span class="p">[</span><span class="n">movie1</span><span class="p">],</span> <span class="n">node_embeddings</span><span class="p">[</span><span class="n">movie4</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.5913276672363281</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since we worked with integer ids for nodes, let's create reverse mapping dictionaries that map integer user/movie to their actual ids.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">reverse_movie2dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="n">movie2dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">reverse_user2dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="n">user2dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">node_vecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_embeddings</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cnt</span><span class="p">)]</span>
<span class="n">node_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">node_vecs</span><span class="p">)</span>
<span class="n">node_vecs</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(10334, 50)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Movies similar to a given movie as an evaluation of the system.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">get_similar_movies_graph_embeddings</span><span class="p">(</span><span class="n">movieid</span><span class="p">,</span> <span class="n">movie_embed</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">movie_idx</span> <span class="o">=</span> <span class="n">movie2dict</span><span class="p">[</span><span class="n">movieid</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">movie_embed</span><span class="p">[</span><span class="n">movie_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ranking</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">movie_embed</span><span class="p">)</span>
    <span class="n">top_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">ranking</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">top_movie_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">reverse_movie2dict</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">top_ids</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">reverse_movie2dict</span><span class="p">][:</span><span class="n">top_n</span><span class="p">]</span>
    <span class="n">sim_movies</span> <span class="o">=</span> <span class="p">[</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">top_movie_ids</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sim_movies</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">get_similar_movies_graph_embeddings</span><span class="p">((</span><span class="mi">260</span><span class="p">,</span> <span class="s1">'movie'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['Priest (1994)',
 'Heidi Fleiss: Hollywood Madam (1995)',
 'My Crazy Life (Mi vida loca) (1993)',
 'Before the Rain (Pred dozhdot) (1994)',
 'Boys of St. Vincent, The (1992)',
 'Last Dance (1996)',
 'Awfully Big Adventure, An (1995)',
 'Queen Margot (Reine Margot, La) (1994)',
 "Widows' Peak (1994)",
 'What Happened Was... (1994)']</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">get_similar_movies_graph_embeddings</span><span class="p">((</span><span class="mi">122</span><span class="p">,</span> <span class="s1">'movie'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['Awfully Big Adventure, An (1995)',
 'What Happened Was... (1994)',
 'Song of the Little Road (Pather Panchali) (1955)',
 'Death and the Maiden (1994)',
 'Heidi Fleiss: Hollywood Madam (1995)',
 'My Crazy Life (Mi vida loca) (1993)',
 'Love &amp; Human Remains (1993)',
 "It's My Party (1996)",
 'Perez Family, The (1995)',
 'Bitter Moon (1992)']</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also define the recommendation model based on the cosine similarity i.e the movies are ranked for a given user in terms of the cosine similarities of their corresponding embeddings with the embedding of the user.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">get_recommended_movies_graph_embeddings</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">node_embed</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">user_idx</span> <span class="o">=</span> <span class="n">user2dict</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">node_embed</span><span class="p">[</span><span class="n">user_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ranking</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">node_embed</span><span class="p">)</span>
    <span class="n">top_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">ranking</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">top_movie_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">reverse_movie2dict</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">top_ids</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">reverse_movie2dict</span><span class="p">][:</span><span class="n">top_n</span><span class="p">]</span>
    <span class="n">reco_movies</span> <span class="o">=</span> <span class="p">[</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">top_movie_ids</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">reco_movies</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['Best Men (1997)',
 'Newton Boys, The (1998)',
 'Howard the Duck (1986)',
 "Gulliver's Travels (1939)",
 'Shaft (1971)',
 'Teenage Mutant Ninja Turtles III (1993)',
 'Welcome to Woop-Woop (1997)',
 'Song of the South (1946)',
 'Three Caballeros, The (1945)',
 'Lord of the Rings, The (1978)']</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Evaluation">
<a class="anchor" href="#Evaluation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Evaluation<a class="anchor-link" href="#Evaluation"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As another evalution, let's compare the generated recommendation for a user to the movies tnat the user has actually rated highly. We will get top 10 recommendations for a user, ranked by the cosine similarity, and compute how many of these movies comes from the set of the movies that the user has rated &gt;= 4.5. This tantamounts to Precision@10 metric. For comparison, we will also compute the Precision for the recommendations produced by the matrix factorization model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">true_pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rating_df</span><span class="p">[(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'userId'</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'rating'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">4.5</span><span class="p">)]</span><span class="o">.</span><span class="n">movieId</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
<span class="n">recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{"Gulliver's Travels (1939)",
 'Lord of the Rings, The (1978)',
 'Newton Boys, The (1998)',
 'Shaft (1971)',
 'Three Caballeros, The (1945)'}</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">mf_recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommendations_matrix_factorization</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">user_factors</span><span class="p">,</span> <span class="n">movie_factors</span><span class="p">))</span>
<span class="n">mf_recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>set()</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">true_pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rating_df</span><span class="p">[(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'userId'</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'rating'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">4.5</span><span class="p">)]</span><span class="o">.</span><span class="n">movieId</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
<span class="n">recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'Dark Knight, The (2008)',
 'Inglourious Basterds (2009)',
 'The Jinx: The Life and Deaths of Robert Durst (2015)',
 'Warrior (2011)',
 'Wolf of Wall Street, The (2013)'}</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">mf_recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommendations_matrix_factorization</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">user_factors</span><span class="p">,</span> <span class="n">movie_factors</span><span class="p">))</span>
<span class="n">mf_recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>set()</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">true_pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rating_df</span><span class="p">[(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'userId'</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'rating'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">4.5</span><span class="p">)]</span><span class="o">.</span><span class="n">movieId</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
<span class="n">recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'Alien Contamination (1980)',
 'Android (1982)',
 'Clonus Horror, The (1979)',
 'Death Race 2000 (1975)',
 'Galaxy of Terror (Quest) (1981)',
 'Hangar 18 (1980)',
 'Looker (1981)',
 'Master of the Flying Guillotine (Du bi quan wang da po xue di zi) (1975)',
 'Saturn 3 (1980)',
 'The Lair of the White Worm (1988)'}</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">mf_recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommendations_matrix_factorization</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">user_factors</span><span class="p">,</span> <span class="n">movie_factors</span><span class="p">))</span>
<span class="n">mf_recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>set()</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Enriched-network-with-additional-information-:-Genres">
<a class="anchor" href="#Enriched-network-with-additional-information-:-Genres" aria-hidden="true"><span class="octicon octicon-link"></span></a>Enriched network with additional information : Genres<a class="anchor-link" href="#Enriched-network-with-additional-information-:-Genres"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Genres of the movies can be used as additional signal for better recommendations</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">movie_genre_edgelist</span> <span class="o">=</span> <span class="n">movie_df</span><span class="p">[[</span><span class="s1">'movieId'</span><span class="p">,</span> <span class="s1">'genres'</span><span class="p">]]</span>
<span class="n">movie_genre_edgelist</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Adventure|Animation|Children|Comedy|Fantasy</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Adventure|Children|Fantasy</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Comedy</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">genre2int</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'(no genres listed)': 10353,
 'Action': 10341,
 'Adventure': 10334,
 'Animation': 10335,
 'Children': 10336,
 'Comedy': 10337,
 'Crime': 10342,
 'Documentary': 10349,
 'Drama': 10340,
 'Fantasy': 10338,
 'Film-Noir': 10352,
 'Horror': 10344,
 'IMAX': 10350,
 'Musical': 10348,
 'Mystery': 10345,
 'Romance': 10339,
 'Sci-Fi': 10346,
 'Thriller': 10343,
 'War': 10347,
 'Western': 10351}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Combine the user-movie and movie-genre graph</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">user_movie_genre_graph</span> <span class="o">=</span>  <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
<span class="n">user_movie_genre_graph</span><span class="o">.</span><span class="n">add_weighted_edges_from</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">user_movie_graph</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="s1">'weight'</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">user_movie_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">()])</span>
<span class="n">user_movie_genre_graph</span><span class="o">.</span><span class="n">add_weighted_edges_from</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">movie_genre_graph</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="s1">'weight'</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">movie_genre_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">()])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">user_movie_genre_graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>122882</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">G_enriched</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">user_movie_genre_graph</span><span class="p">,</span> <span class="n">is_directed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">G_enriched</span><span class="o">.</span><span class="n">preprocess_transition_probs</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">walks_enriched</span> <span class="o">=</span> <span class="n">G_enriched</span><span class="o">.</span><span class="n">simulate_walks</span><span class="p">(</span><span class="n">num_walks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">walk_length</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Walk iteration:
1 / 10
2 / 10
3 / 10
4 / 10
5 / 10
6 / 10
7 / 10
8 / 10
9 / 10
10 / 10
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">node_embeddings_enriched</span> <span class="o">=</span> <span class="n">learn_embeddings</span><span class="p">(</span><span class="n">walks_enriched</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">node_vecs_enriched</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_embeddings_enriched</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cnt</span><span class="p">)]</span>
<span class="n">node_vecs_enriched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">node_vecs_enriched</span><span class="p">)</span>
<span class="n">node_vecs_enriched</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(10354, 50)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">get_similar_movies_graph_embeddings</span><span class="p">((</span><span class="mi">260</span><span class="p">,</span> <span class="s1">'movie'</span><span class="p">),</span> <span class="n">node_vecs_enriched</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['Priest (1994)',
 'Mrs. Parker and the Vicious Circle (1994)',
 'Last Dance (1996)',
 'Tom &amp; Viv (1994)',
 'Georgia (1995)',
 'My Crazy Life (Mi vida loca) (1993)',
 'Before the Rain (Pred dozhdot) (1994)',
 'Haunted World of Edward D. Wood Jr., The (1996)',
 'To Live (Huozhe) (1994)',
 'Vanya on 42nd Street (1994)']</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">get_similar_movies_graph_embeddings</span><span class="p">((</span><span class="mi">260</span><span class="p">,</span> <span class="s1">'movie'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['Priest (1994)',
 'Heidi Fleiss: Hollywood Madam (1995)',
 'My Crazy Life (Mi vida loca) (1993)',
 'Before the Rain (Pred dozhdot) (1994)',
 'Boys of St. Vincent, The (1992)',
 'Last Dance (1996)',
 'Awfully Big Adventure, An (1995)',
 'Queen Margot (Reine Margot, La) (1994)',
 "Widows' Peak (1994)",
 'What Happened Was... (1994)']</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">true_pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rating_df</span><span class="p">[(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'userId'</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'rating'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">4.5</span><span class="p">)]</span><span class="o">.</span><span class="n">movieId</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>

<span class="n">mf_recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommendations_matrix_factorization</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">user_factors</span><span class="p">,</span> <span class="n">movie_factors</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)))</span>

<span class="n">ge_recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ge_recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)))</span>

<span class="n">ge_enriched_reso</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs_enriched</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ge_enriched_reso</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0
5
5
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">true_pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rating_df</span><span class="p">[(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'userId'</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'rating'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">4.5</span><span class="p">)]</span><span class="o">.</span><span class="n">movieId</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>

<span class="n">mf_recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommendations_matrix_factorization</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">user_factors</span><span class="p">,</span> <span class="n">movie_factors</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)))</span>

<span class="n">ge_recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ge_recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)))</span>

<span class="n">ge_enriched_reso</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs_enriched</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ge_enriched_reso</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0
2
1
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">true_pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">movie_df</span><span class="p">[</span><span class="n">movie_df</span><span class="o">.</span><span class="n">movieId</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rating_df</span><span class="p">[(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'userId'</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rating_df</span><span class="p">[</span><span class="s1">'rating'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">4.5</span><span class="p">)]</span><span class="o">.</span><span class="n">movieId</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>

<span class="n">mf_recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommendations_matrix_factorization</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">user_factors</span><span class="p">,</span> <span class="n">movie_factors</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)))</span>

<span class="n">ge_recos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ge_recos</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)))</span>

<span class="n">ge_enriched_reso</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_recommended_movies_graph_embeddings</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s1">'user'</span><span class="p">),</span> <span class="n">node_vecs_enriched</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ge_enriched_reso</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">true_pos</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0
0
1
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="sparsh-ai/rec-tutorials"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/rec-tutorials/graph%20embedding%20movielens%20factorization/2021/04/24/Recommendation-Node2vec.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/rec-tutorials/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/rec-tutorials/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/rec-tutorials/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials on Recommender Systems with ready-to-use jupyter notebooks</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/sparsh-ai" title="sparsh-ai"><svg class="svg-icon grey"><use xlink:href="/rec-tutorials/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
