<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Neural Matrix Factorization from scratch in PyTorch | rec-tutorials</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Neural Matrix Factorization from scratch in PyTorch" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A tutorial to understand the process of building a Neural Matrix Factorization model from scratch in PyTorch on MovieLens-1M dataset." />
<meta property="og:description" content="A tutorial to understand the process of building a Neural Matrix Factorization model from scratch in PyTorch on MovieLens-1M dataset." />
<link rel="canonical" href="https://sparsh-ai.github.io/rec-tutorials/matrixfactorization%20movielens%20pytorch%20scratch/2021/04/21/rec-algo-ncf-pytorch-pyy0715.html" />
<meta property="og:url" content="https://sparsh-ai.github.io/rec-tutorials/matrixfactorization%20movielens%20pytorch%20scratch/2021/04/21/rec-algo-ncf-pytorch-pyy0715.html" />
<meta property="og:site_name" content="rec-tutorials" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-21T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://sparsh-ai.github.io/rec-tutorials/matrixfactorization%20movielens%20pytorch%20scratch/2021/04/21/rec-algo-ncf-pytorch-pyy0715.html","@type":"BlogPosting","headline":"Neural Matrix Factorization from scratch in PyTorch","dateModified":"2021-04-21T00:00:00-05:00","datePublished":"2021-04-21T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://sparsh-ai.github.io/rec-tutorials/matrixfactorization%20movielens%20pytorch%20scratch/2021/04/21/rec-algo-ncf-pytorch-pyy0715.html"},"description":"A tutorial to understand the process of building a Neural Matrix Factorization model from scratch in PyTorch on MovieLens-1M dataset.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/rec-tutorials/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://sparsh-ai.github.io/rec-tutorials/feed.xml" title="rec-tutorials" /><link rel="shortcut icon" type="image/x-icon" href="/rec-tutorials/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/rec-tutorials/">rec-tutorials</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/rec-tutorials/about/">About Me</a><a class="page-link" href="/rec-tutorials/search/">Search</a><a class="page-link" href="/rec-tutorials/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Neural Matrix Factorization from scratch in PyTorch</h1><p class="page-description">A tutorial to understand the process of building a **Neural Matrix Factorization** model from scratch in PyTorch on MovieLens-1M dataset.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-04-21T00:00:00-05:00" itemprop="datePublished">
        Apr 21, 2021
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/rec-tutorials/categories/#matrixfactorization movielens pytorch scratch">matrixfactorization movielens pytorch scratch</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/sparsh-ai/rec-tutorials/tree/master/_notebooks/2021-04-21-rec-algo-ncf-pytorch-pyy0715.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/rec-tutorials/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/sparsh-ai/rec-tutorials/master?filepath=_notebooks%2F2021-04-21-rec-algo-ncf-pytorch-pyy0715.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/rec-tutorials/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/sparsh-ai/rec-tutorials/blob/master/_notebooks/2021-04-21-rec-algo-ncf-pytorch-pyy0715.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/rec-tutorials/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Downloading-Movielens-1M-Ratings">Downloading Movielens-1M Ratings </a></li>
<li class="toc-entry toc-h2"><a href="#Defining-Dataset-Classes">Defining Dataset Classes </a>
<ul>
<li class="toc-entry toc-h3"><a href="#NCF-Dataset-Class">NCF Dataset Class </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Defining-Metrics">Defining Metrics </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Defining-Model-Architectures">Defining Model Architectures </a></li>
<li class="toc-entry toc-h3"><a href="#Setting-Arguments">Setting Arguments </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Training-NeuMF-Model">Training NeuMF Model </a></li>
<li class="toc-entry toc-h2"><a href="#Final-Output">Final Output </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-04-21-rec-algo-ncf-pytorch-pyy0715.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install -q tensorboardX
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 122kB 8.3MB/s 
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> 
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span> <span class="k">as</span> <span class="nn">data</span>
<span class="kn">from</span> <span class="nn">tensorboardX</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Downloading-Movielens-1M-Ratings">
<a class="anchor" href="#Downloading-Movielens-1M-Ratings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Downloading Movielens-1M Ratings<a class="anchor-link" href="#Downloading-Movielens-1M-Ratings"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DATA_URL</span> <span class="o">=</span> <span class="s2">"https://raw.githubusercontent.com/sparsh-ai/rec-data-public/master/ml-1m-dat/ratings.dat"</span>
<span class="n">MAIN_PATH</span> <span class="o">=</span> <span class="s1">'/content/'</span>
<span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">MAIN_PATH</span> <span class="o">+</span> <span class="s1">'ratings.dat'</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">MAIN_PATH</span> <span class="o">+</span> <span class="s1">'models/'</span>
<span class="n">MODEL</span> <span class="o">=</span> <span class="s1">'ml-1m_Neu_MF'</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>wget -nc https://raw.githubusercontent.com/sparsh-ai/rec-data-public/master/ml-1m-dat/ratings.dat
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Defining-Dataset-Classes">
<a class="anchor" href="#Defining-Dataset-Classes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining Dataset Classes<a class="anchor-link" href="#Defining-Dataset-Classes"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Rating_Datset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_list</span><span class="p">,</span> <span class="n">item_list</span><span class="p">,</span> <span class="n">rating_list</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">Rating_Datset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">user_list</span> <span class="o">=</span> <span class="n">user_list</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">item_list</span> <span class="o">=</span> <span class="n">item_list</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rating_list</span> <span class="o">=</span> <span class="n">rating_list</span>

	<span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
		<span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
		<span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
		<span class="n">rating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rating_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
		
		<span class="k">return</span> <span class="p">(</span>
			<span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
			<span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
			<span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
			<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="NCF-Dataset-Class">
<a class="anchor" href="#NCF-Dataset-Class" aria-hidden="true"><span class="octicon octicon-link"></span></a>NCF Dataset Class<a class="anchor-link" href="#NCF-Dataset-Class"> </a>
</h3>
<ul>
<li>
<em>_reindex</em>: process dataset to reindex userID and itemID, also set rating as binary feedback</li>
<li>
<em>_leave_one_out</em>: leave-one-out evaluation protocol in paper <a href="https://www.comp.nus.edu.sg/~xiangnan/papers/ncf.pdf">https://www.comp.nus.edu.sg/~xiangnan/papers/ncf.pdf</a>
</li>
<li>
<em>negative_sampling</em>: randomly selects n negative examples for each positive one</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">NCF_Data</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">"""</span>
<span class="sd">	Construct Dataset for NCF</span>
<span class="sd">	"""</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">ratings</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">num_ng</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_ng</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">num_ng_test</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_ng_test</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratings</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">user_pool</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratings</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">item_pool</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratings</span><span class="p">[</span><span class="s1">'item_id'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leave_one_out</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">negatives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_sampling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_ratings</span><span class="p">)</span>
		<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
	
	<span class="k">def</span> <span class="nf">_reindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">):</span>
		<span class="sd">"""</span>
<span class="sd">		Process dataset to reindex userID and itemID, also set rating as binary feedback</span>
<span class="sd">		"""</span>
		<span class="n">user_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
		<span class="n">user2id</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_list</span><span class="p">)}</span>

		<span class="n">item_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">'item_id'</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
		<span class="n">item2id</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">item_list</span><span class="p">)}</span>

		<span class="n">ratings</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">user2id</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
		<span class="n">ratings</span><span class="p">[</span><span class="s1">'item_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">'item_id'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">item2id</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
		<span class="n">ratings</span><span class="p">[</span><span class="s1">'rating'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">'rating'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ratings</span>

	<span class="k">def</span> <span class="nf">_leave_one_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">):</span>
		<span class="sd">"""</span>
<span class="sd">		leave-one-out evaluation protocol in paper https://www.comp.nus.edu.sg/~xiangnan/papers/ncf.pdf</span>
<span class="sd">		"""</span>
		<span class="n">ratings</span><span class="p">[</span><span class="s1">'rank_latest'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'user_id'</span><span class="p">])[</span><span class="s1">'timestamp'</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">'first'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">test</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">'rank_latest'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
		<span class="n">train</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ratings</span><span class="p">[</span><span class="s1">'rank_latest'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
		<span class="k">assert</span> <span class="n">train</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">==</span><span class="n">test</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="s1">'Not Match Train User with Test User'</span>
		<span class="k">return</span> <span class="n">train</span><span class="p">[[</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'item_id'</span><span class="p">,</span> <span class="s1">'rating'</span><span class="p">]],</span> <span class="n">test</span><span class="p">[[</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'item_id'</span><span class="p">,</span> <span class="s1">'rating'</span><span class="p">]]</span>

	<span class="k">def</span> <span class="nf">_negative_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">):</span>
		<span class="n">interact_status</span> <span class="o">=</span> <span class="p">(</span>
			<span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'user_id'</span><span class="p">)[</span><span class="s1">'item_id'</span><span class="p">]</span>
			<span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
			<span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
			<span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'item_id'</span><span class="p">:</span> <span class="s1">'interacted_items'</span><span class="p">}))</span>
		<span class="n">interact_status</span><span class="p">[</span><span class="s1">'negative_items'</span><span class="p">]</span> <span class="o">=</span> <span class="n">interact_status</span><span class="p">[</span><span class="s1">'interacted_items'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_pool</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
		<span class="n">interact_status</span><span class="p">[</span><span class="s1">'negative_samples'</span><span class="p">]</span> <span class="o">=</span> <span class="n">interact_status</span><span class="p">[</span><span class="s1">'negative_items'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ng_test</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">interact_status</span><span class="p">[[</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'negative_items'</span><span class="p">,</span> <span class="s1">'negative_samples'</span><span class="p">]]</span>

	<span class="k">def</span> <span class="nf">get_train_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">ratings</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
		<span class="n">train_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">negatives</span><span class="p">[[</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'negative_items'</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">'user_id'</span><span class="p">)</span>
		<span class="n">train_ratings</span><span class="p">[</span><span class="s1">'negatives'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_ratings</span><span class="p">[</span><span class="s1">'negative_items'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ng</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">train_ratings</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
			<span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span>
			<span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">item_id</span><span class="p">))</span>
			<span class="n">ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">rating</span><span class="p">))</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ng</span><span class="p">):</span>
				<span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span>
				<span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">negatives</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="n">ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># negative samples get 0 rating</span>
		<span class="n">dataset</span> <span class="o">=</span> <span class="n">Rating_Datset</span><span class="p">(</span>
			<span class="n">user_list</span><span class="o">=</span><span class="n">users</span><span class="p">,</span>
			<span class="n">item_list</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
			<span class="n">rating_list</span><span class="o">=</span><span class="n">ratings</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">get_test_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">ratings</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
		<span class="n">test_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_ratings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">negatives</span><span class="p">[[</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'negative_samples'</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">'user_id'</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">test_ratings</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
			<span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span>
			<span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">item_id</span><span class="p">))</span>
			<span class="n">ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">rating</span><span class="p">))</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">'negative_samples'</span><span class="p">):</span>
				<span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span>
				<span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
				<span class="n">ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">dataset</span> <span class="o">=</span> <span class="n">Rating_Datset</span><span class="p">(</span>
			<span class="n">user_list</span><span class="o">=</span><span class="n">users</span><span class="p">,</span>
			<span class="n">item_list</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
			<span class="n">rating_list</span><span class="o">=</span><span class="n">ratings</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ng_test</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Defining-Metrics">
<a class="anchor" href="#Defining-Metrics" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining Metrics<a class="anchor-link" href="#Defining-Metrics"> </a>
</h2>
<p>Using Hit Rate and NDCG as our evaluation <em>metrics</em></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">hit</span><span class="p">(</span><span class="n">ng_item</span><span class="p">,</span> <span class="n">pred_items</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">ng_item</span> <span class="ow">in</span> <span class="n">pred_items</span><span class="p">:</span>
		<span class="k">return</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">ndcg</span><span class="p">(</span><span class="n">ng_item</span><span class="p">,</span> <span class="n">pred_items</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">ng_item</span> <span class="ow">in</span> <span class="n">pred_items</span><span class="p">:</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">pred_items</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ng_item</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
	<span class="k">return</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
	<span class="n">HR</span><span class="p">,</span> <span class="n">NDCG</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

	<span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
		<span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

		<span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
		<span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>
		<span class="n">recommends</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">take</span><span class="p">(</span>
				<span class="n">item</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

		<span class="n">ng_item</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="c1"># leave one-out evaluation has only one item per user</span>
		<span class="n">HR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hit</span><span class="p">(</span><span class="n">ng_item</span><span class="p">,</span> <span class="n">recommends</span><span class="p">))</span>
		<span class="n">NDCG</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndcg</span><span class="p">(</span><span class="n">ng_item</span><span class="p">,</span> <span class="n">recommends</span><span class="p">))</span>

	<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">HR</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">NDCG</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Defining-Model-Architectures">
<a class="anchor" href="#Defining-Model-Architectures" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining Model Architectures<a class="anchor-link" href="#Defining-Model-Architectures"> </a>
</h3>
<ol>
<li>Generalized Matrix Factorization</li>
<li>Multi Layer Perceptron</li>
<li>Neural Matrix Factorization</li>
</ol>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Generalized_Matrix_Factorization</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Generalized_Matrix_Factorization</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">num_users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="n">num_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">factor_num</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_user</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_num</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_item</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_num</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">affine_output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_num</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logistic</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_indices</span><span class="p">,</span> <span class="n">item_indices</span><span class="p">):</span>
        <span class="n">user_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_user</span><span class="p">(</span><span class="n">user_indices</span><span class="p">)</span>
        <span class="n">item_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_item</span><span class="p">(</span><span class="n">item_indices</span><span class="p">)</span>
        <span class="n">element_product</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">user_embedding</span><span class="p">,</span> <span class="n">item_embedding</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine_output</span><span class="p">(</span><span class="n">element_product</span><span class="p">)</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logistic</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rating</span>

    <span class="k">def</span> <span class="nf">init_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Multi_Layer_Perceptron</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Multi_Layer_Perceptron</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">num_users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="n">num_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">factor_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">layers</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_user</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_num</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_item</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_num</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">affine_output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logistic</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_indices</span><span class="p">,</span> <span class="n">item_indices</span><span class="p">):</span>
        <span class="n">user_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_user</span><span class="p">(</span><span class="n">user_indices</span><span class="p">)</span>
        <span class="n">item_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_item</span><span class="p">(</span><span class="n">item_indices</span><span class="p">)</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_embedding</span><span class="p">,</span> <span class="n">item_embedding</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># the concat latent vector</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span><span class="p">))):</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span><span class="p">[</span><span class="n">idx</span><span class="p">](</span><span class="n">vector</span><span class="p">)</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="n">vector</span><span class="p">)</span>
            <span class="c1"># vector = nn.BatchNorm1d()(vector)</span>
            <span class="c1"># vector = nn.Dropout(p=0.5)(vector)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine_output</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logistic</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rating</span>

    <span class="k">def</span> <span class="nf">init_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">NeuMF</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NeuMF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">num_users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="n">num_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor_num_mf</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">factor_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor_num_mlp</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dropout</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_user_mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_num_mlp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_item_mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_num_mlp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_user_mf</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_num_mf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_item_mf</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_num_mf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">layers</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">affine_output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_num_mf</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logistic</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_weight</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_user_mlp</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_item_mlp</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_user_mf</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_item_mf</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affine_output</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_indices</span><span class="p">,</span> <span class="n">item_indices</span><span class="p">):</span>
        <span class="n">user_embedding_mlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_user_mlp</span><span class="p">(</span><span class="n">user_indices</span><span class="p">)</span>
        <span class="n">item_embedding_mlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_item_mlp</span><span class="p">(</span><span class="n">item_indices</span><span class="p">)</span>

        <span class="n">user_embedding_mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_user_mf</span><span class="p">(</span><span class="n">user_indices</span><span class="p">)</span>
        <span class="n">item_embedding_mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_item_mf</span><span class="p">(</span><span class="n">item_indices</span><span class="p">)</span>

        <span class="n">mlp_vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_embedding_mlp</span><span class="p">,</span> <span class="n">item_embedding_mlp</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mf_vector</span> <span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">user_embedding_mf</span><span class="p">,</span> <span class="n">item_embedding_mf</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span><span class="p">))):</span>
            <span class="n">mlp_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span><span class="p">[</span><span class="n">idx</span><span class="p">](</span><span class="n">mlp_vector</span><span class="p">)</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">mlp_vector</span><span class="p">,</span> <span class="n">mf_vector</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine_output</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logistic</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rating</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Setting-Arguments">
<a class="anchor" href="#Setting-Arguments" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting Arguments<a class="anchor-link" href="#Setting-Arguments"> </a>
</h3>
<p>Here is the brief description of important ones:</p>
<ul>
<li>Learning rate is 0.001</li>
<li>Dropout rate is 0.2</li>
<li>Running for 10 epochs</li>
<li>HitRate@10 and NDCG@10</li>
<li>4 negative samples for each positive one</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--seed"</span><span class="p">,</span> 
	<span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> 
	<span class="n">default</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
	<span class="n">help</span><span class="o">=</span><span class="s2">"Seed"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--lr"</span><span class="p">,</span> 
	<span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> 
	<span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> 
	<span class="n">help</span><span class="o">=</span><span class="s2">"learning rate"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--dropout"</span><span class="p">,</span> 
	<span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
	<span class="n">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>  
	<span class="n">help</span><span class="o">=</span><span class="s2">"dropout rate"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--batch_size"</span><span class="p">,</span> 
	<span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> 
	<span class="n">default</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> 
	<span class="n">help</span><span class="o">=</span><span class="s2">"batch size for training"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--epochs"</span><span class="p">,</span> 
	<span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
	<span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  
	<span class="n">help</span><span class="o">=</span><span class="s2">"training epoches"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--top_k"</span><span class="p">,</span> 
	<span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> 
	<span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
	<span class="n">help</span><span class="o">=</span><span class="s2">"compute metrics@top_k"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--factor_num"</span><span class="p">,</span> 
	<span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
	<span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> 
	<span class="n">help</span><span class="o">=</span><span class="s2">"predictive factors numbers in the model"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--layers"</span><span class="p">,</span>
    <span class="n">nargs</span><span class="o">=</span><span class="s1">'+'</span><span class="p">,</span> 
    <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">"MLP layers. Note that the first layer is the concatenation of user </span><span class="se">\</span>
<span class="s2">    and item embeddings. So layers[0]/2 is the embedding size."</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--num_ng"</span><span class="p">,</span> 
	<span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
	<span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
	<span class="n">help</span><span class="o">=</span><span class="s2">"Number of negative samples for training set"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--num_ng_test"</span><span class="p">,</span> 
	<span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
	<span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
	<span class="n">help</span><span class="o">=</span><span class="s2">"Number of negative samples for test set"</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--out"</span><span class="p">,</span> 
	<span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="n">help</span><span class="o">=</span><span class="s2">"save model or not"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>_StoreAction(option_strings=['--out'], dest='out', nargs=None, const=None, default=True, type=None, choices=None, help='save model or not', metavar=None)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training-NeuMF-Model">
<a class="anchor" href="#Training-NeuMF-Model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Training NeuMF Model<a class="anchor-link" href="#Training-NeuMF-Model"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda:0"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">()</span>

<span class="c1"># seed for Reproducibility</span>
<span class="n">seed_everything</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

<span class="c1"># load data</span>
<span class="n">ml_1m</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
	<span class="n">DATA_PATH</span><span class="p">,</span> 
	<span class="n">sep</span><span class="o">=</span><span class="s2">"::"</span><span class="p">,</span> 
	<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'item_id'</span><span class="p">,</span> <span class="s1">'rating'</span><span class="p">,</span> <span class="s1">'timestamp'</span><span class="p">],</span> 
	<span class="n">engine</span><span class="o">=</span><span class="s1">'python'</span><span class="p">)</span>

<span class="c1"># set the num_users, items</span>
<span class="n">num_users</span> <span class="o">=</span> <span class="n">ml_1m</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
<span class="n">num_items</span> <span class="o">=</span> <span class="n">ml_1m</span><span class="p">[</span><span class="s1">'item_id'</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>

<span class="c1"># construct the train and test datasets</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">NCF_Data</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">ml_1m</span><span class="p">)</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_train_instance</span><span class="p">()</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_test_instance</span><span class="p">()</span>

<span class="c1"># set model and loss, optimizer</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">NeuMF</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">loss_function</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>

<span class="c1"># train, evaluation</span>
<span class="n">best_hr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
	<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span> <span class="c1"># Enable dropout (if have).</span>
	<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

	<span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
		<span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
		<span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

		<span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
		<span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
		<span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
		<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
		<span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">'loss/Train_loss'</span><span class="p">,</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">epoch</span><span class="p">)</span>

	<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
	<span class="n">HR</span><span class="p">,</span> <span class="n">NDCG</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">top_k</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">'Perfomance/HR@10'</span><span class="p">,</span> <span class="n">HR</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">'Perfomance/NDCG@10'</span><span class="p">,</span> <span class="n">NDCG</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>

	<span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
	<span class="nb">print</span><span class="p">(</span><span class="s2">"The time elapse of epoch </span><span class="si">{:03d}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s2">" is: "</span> <span class="o">+</span> 
			<span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%H: %M: %S"</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)))</span>
	<span class="nb">print</span><span class="p">(</span><span class="s2">"HR: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG: </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">HR</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">NDCG</span><span class="p">)))</span>

	<span class="k">if</span> <span class="n">HR</span> <span class="o">&gt;</span> <span class="n">best_hr</span><span class="p">:</span>
		<span class="n">best_hr</span><span class="p">,</span> <span class="n">best_ndcg</span><span class="p">,</span> <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">HR</span><span class="p">,</span> <span class="n">NDCG</span><span class="p">,</span> <span class="n">epoch</span>
		<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">):</span>
				<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span>
			<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> 
				<span class="s1">'</span><span class="si">{}{}</span><span class="s1">.pth'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">,</span> <span class="n">MODEL</span><span class="p">))</span>

<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/usr/local/lib/python3.7/dist-packages/torch/utils/data/dataloader.py:477: UserWarning: This DataLoader will create 4 worker processes in total. Our suggested max number of worker in current system is 2, which is smaller than what this DataLoader is going to create. Please be aware that excessive worker creation might get DataLoader running slow or even freeze, lower the worker number to avoid potential slowness/freeze if necessary.
  cpuset_checked))
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The time elapse of epoch 001 is: 00: 02: 30
HR: 0.624	NDCG: 0.362
The time elapse of epoch 002 is: 00: 02: 31
HR: 0.663	NDCG: 0.392
The time elapse of epoch 003 is: 00: 02: 30
HR: 0.673	NDCG: 0.399
The time elapse of epoch 004 is: 00: 02: 30
HR: 0.677	NDCG: 0.402
The time elapse of epoch 005 is: 00: 02: 31
HR: 0.671	NDCG: 0.399
The time elapse of epoch 006 is: 00: 02: 32
HR: 0.671	NDCG: 0.400
The time elapse of epoch 007 is: 00: 02: 32
HR: 0.669	NDCG: 0.400
The time elapse of epoch 008 is: 00: 02: 31
HR: 0.665	NDCG: 0.395
The time elapse of epoch 009 is: 00: 02: 33
HR: 0.664	NDCG: 0.393
The time elapse of epoch 010 is: 00: 02: 32
HR: 0.667	NDCG: 0.394
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Final-Output">
<a class="anchor" href="#Final-Output" aria-hidden="true"><span class="octicon octicon-link"></span></a>Final Output<a class="anchor-link" href="#Final-Output"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Best epoch </span><span class="si">{:03d}</span><span class="s2">: HR = </span><span class="si">{:.3f}</span><span class="s2">, NDCG = </span><span class="si">{:.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
									<span class="n">best_epoch</span><span class="p">,</span> <span class="n">best_hr</span><span class="p">,</span> <span class="n">best_ndcg</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="sparsh-ai/rec-tutorials"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/rec-tutorials/matrixfactorization%20movielens%20pytorch%20scratch/2021/04/21/rec-algo-ncf-pytorch-pyy0715.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/rec-tutorials/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/rec-tutorials/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/rec-tutorials/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials on Recommender Systems with ready-to-use jupyter notebooks</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/sparsh-ai" title="sparsh-ai"><svg class="svg-icon grey"><use xlink:href="/rec-tutorials/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
